---
layout: post
title: "Run EF Core Migrations in multiple databases with Azure DevOps"
subtitle: "This post is about running Entity Framework Core migrations on Azure DevOps which helps you to continuously deploy your database changes to multiple databases."
date: 2021-08-12 00:00:00
categories: [Azure,DevOps,EFCore]
tags: [Azure,DevOps,EFCore]
author: "Anuraj"
image: /assets/images/2021/08/existing_build_pipeline.png
---
This is a follow-up post. Last year I wrote a [blog post](https://dotnetthoughts.net/run-ef-core-migrations-in-azure-devops/) running EF Core migrations in Azure DevOps. And I received few comments asking about how to deploy the script to multiple databases instead of a single database. So in this post, I will explain how to deploy the script in multiple databases.

In this blog post, I am implementing the solution for the SQL Server database. This solution is useful if you're developing SAAS applications with isolated databases for each tenant or customer. Here is my existing build pipeline, which deploys the generated script to SQL Server using Azure SQL Database deployment task. 

![Azure DevOps Build Pipeline]({{ site.url }}/assets/images/2021/08/existing_build_pipeline.png)

To deploy to multiple databases, first I am creating buildÂ environment variable with the connection string to master database. It can be any database. 

![Azure DevOps Build Pipeline variable]({{ site.url }}/assets/images/2021/08/buildpipeline_variables.png)

Next, I am disabling the Azure SQL Database deployment task and adding a Powershell Script task. You can choose the Inline Type. 

![Powershell Task added]({{ site.url }}/assets/images/2021/08/powershell_task_added.png)

And add the following code in the script, you can commit this code into source control and configure it as file, for the demo purposes I am using Inline option.

{% highlight text %}
{% raw %}
$masterdb = "master"
$scriptFile = "$(build.artifactstagingdirectory)/tododbscript.sql"
$databases = Invoke-Sqlcmd `
  -Query "SELECT name FROM sys.databases WHERE name NOT IN ('master', 'tempdb', 'model', 'msdb')" `
  -ConnectionString $env:MasterConnection
foreach($database in $databases)
{
    $databaseConnection = $env:MasterConnection.Replace($masterdb, $database.name)
    Invoke-Sqlcmd -InputFile $scriptFile -ConnectionString $databaseConnection
}
{% endraw %}
{% endhighlight %}

In this code, first, we will enumerate all databases from the master database - you can customize this step based on your requirements. And in the loop, I am changing the connection string with the database name and then executing the script file generated by EF Core migration with the replaced connection string. This way you can deploy EF Core migration script to multiple databases with out repeating the Azure SQL Database deployment task.

Happy Programming :)